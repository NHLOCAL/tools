<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>עורך כתוביות - JSON ל-SRT</title>

    <!-- Google Fonts & Material Symbols -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <style>
        :root {
            --md-sys-color-primary: #6750A4;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-on-primary-container: #21005D;
            --md-sys-color-secondary: #625B71;
            --md-sys-color-on-secondary-container: #1D192B;
            --md-sys-color-error: #B3261E;
            --md-sys-color-background: #FFFBFE;
            --md-sys-color-on-background: #1C1B1F;
            --md-sys-color-surface: #FFFBFE;
            --md-sys-color-surface-variant: #E7E0EC;
            --md-sys-color-outline: #79747E;
            --md-sys-color-surface-container-low: #F7F2FA;
            --border-radius: 16px;
            --border-radius-small: 8px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { font-family: 'Assistant', sans-serif; background-color: var(--md-sys-color-background); color: var(--md-sys-color-on-background); line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 1.5rem; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; padding-top: 2rem; }
        .card { background-color: var(--md-sys-color-surface-container-low); border-radius: var(--border-radius); padding: 2rem; border: 1px solid var(--md-sys-color-outline-variant); box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        header { padding-top: 1.5rem; }
        h1, h2 { font-weight: 700; color: var(--md-sys-color-primary); }
        h1 { font-size: 2.5rem; display: flex; align-items: center; gap: 1rem; }
        h2 { font-size: 1.5rem; margin-bottom: 1rem; border-bottom: 2px solid var(--md-sys-color-primary-container); padding-bottom: 0.5rem; }
        .material-symbols-outlined { font-size: inherit; vertical-align: middle; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 10px 24px; font-family: 'Assistant', sans-serif; font-size: 1rem; font-weight: 600; border-radius: 99px; border: none; cursor: pointer; transition: all 0.2s ease-in-out; text-decoration: none; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); }
        .btn-primary:hover:not(:disabled) { background-color: #5a3f92; box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .btn-secondary { background-color: var(--md-sys-color-secondary-container); color: var(--md-sys-color-on-secondary-container); }
        .btn-secondary:hover:not(:disabled) { background-color: #d8d0e7; }
        .input-group { margin-bottom: 1.5rem; }
        .input-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--md-sys-color-on-surface-variant); }
        textarea#json-text-input { width: 100%; min-height: 200px; padding: 1rem; border: 1px solid var(--md-sys-color-outline); border-radius: var(--border-radius-small); font-family: monospace; direction: ltr; text-align: left; background-color: var(--md-sys-color-surface); font-size: 0.9rem; resize: vertical; }
        .file-input-wrapper { border: 2px dashed var(--md-sys-color-outline); border-radius: var(--border-radius); padding: 2rem; text-align: center; cursor: pointer; transition: all 0.2s; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
        .file-input-wrapper:hover, .file-input-wrapper.drag-over { background-color: var(--md-sys-color-primary-container); border-color: var(--md-sys-color-primary); }
        .file-input-wrapper .material-symbols-outlined { font-size: 3rem; color: var(--md-sys-color-primary); }
        .file-input-wrapper input[type="file"] { display: none; }
        .file-name { margin-top: 1rem; font-weight: 600; color: var(--md-sys-color-secondary); }
        #editor-section { display: none; }
        .editor-controls { display: flex; gap: 1rem; align-items: center; padding: 1.5rem 0; position: sticky; top: 0; background-color: var(--md-sys-color-background); z-index: 10; border-bottom: 1px solid var(--md-sys-color-surface-variant); }
        #editor-grid { display: grid; grid-template-columns: 40% 1fr; gap: 2rem; align-items: start; padding-top: 2rem; }
        
        /* --- נגן מדיה מעוצב --- */
        #media-player-wrapper { position: relative; }
        #media-player { width: 100%; border-radius: var(--border-radius-small); background-color: black; cursor: pointer; display: block; }
        #audio-poster {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: black; color: white; display: none;
            justify-content: center; align-items: center; text-align: center;
            font-size: 1.2rem; font-weight: 600; padding: 1rem;
            border-radius: var(--border-radius-small);
        }
        #audio-poster.visible { display: flex; }
        #media-player-container { position: sticky; top: 110px; align-self: start; }
        .custom-controls { direction: ltr; background-color: var(--md-sys-color-surface-container-low); border-radius: var(--border-radius); padding: 0.75rem 1rem; margin-top: 1rem; border: 1px solid var(--md-sys-color-surface-variant); }
        .progress-container { display: flex; align-items: center; gap: 1rem; }
        .progress-container .time-display { font-family: monospace; font-size: 0.9rem; color: var(--md-sys-color-secondary); }
        .progress-bar { flex-grow: 1; }
        .bottom-controls { display: flex; align-items: center; justify-content: space-between; margin-top: 0.5rem; }
        .control-btn { background: none; border: none; cursor: pointer; color: var(--md-sys-color-on-surface-variant); padding: 0.5rem; border-radius: 50%; }
        .control-btn:hover { background-color: rgba(0,0,0,0.1); }
        .control-btn .material-symbols-outlined { font-size: 2.25rem; display: block; }
        .volume-container { display: flex; align-items: center; gap: 0.5rem; }
        .volume-container .material-symbols-outlined { font-size: 1.5rem; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; background: var(--md-sys-color-surface-variant); border-radius: 3px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: var(--md-sys-color-primary); margin-top: -5px; }
        
        #subtitle-list-container h3 { margin-bottom: 1rem; color: var(--md-sys-color-secondary); }
        .subtitle-item { background-color: var(--md-sys-color-surface); border: 1px solid var(--md-sys-color-surface-variant); border-radius: var(--border-radius-small); padding: 1rem; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.3s ease-in-out; display: flex; flex-direction: column; gap: 0.75rem; }
        .subtitle-item:hover { border-color: var(--md-sys-color-primary); box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
        .subtitle-item.active { background-color: var(--md-sys-color-primary-container); border-color: var(--md-sys-color-primary); transform: scale(1.02); }
        .subtitle-item .time-inputs { display: flex; gap: 0.5rem; align-items: center; direction: ltr; }
        .subtitle-item .time-input { width: 120px; padding: 4px 8px; border: 1px solid var(--md-sys-color-outline); border-radius: 4px; font-family: monospace; font-size: 0.9rem; direction: ltr; text-align: left; }
        .subtitle-item .text-input { width: 100%; padding: 8px; border: 1px solid var(--md-sys-color-outline); border-radius: 4px; font-family: 'Assistant', sans-serif; font-size: 1rem; resize: vertical; min-height: 40px; direction: rtl; }
        
        #notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background-color: var(--md-sys-color-on-background); color: var(--md-sys-color-background); padding: 12px 24px; border-radius: 99px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; visibility: hidden; transition: all 0.4s ease-in-out; z-index: 1000; }
        #notification.show { opacity: 1; visibility: visible; bottom: 40px; }
        #notification.error { background-color: var(--md-sys-color-error); }
        
        @media (max-width: 900px) {
            #editor-grid { grid-template-columns: 1fr; }
            #media-player-container { position: relative; top: auto; }
        }
        @media (max-width: 768px) {
            .container { padding: 0 1rem; }
            .grid-2 { grid-template-columns: 1fr; }
            h1 { font-size: 2rem; }
            .card { padding: 1.5rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header><h1><span class="material-symbols-outlined" style="font-size: 2.8rem;">subtitles</span> עורך כתוביות חכם</h1></header>
        <main>
            <section id="input-section">
                <div class="grid-2">
                    <div class="card">
                        <h2>שלב 1: הוספת תמלול (JSON)</h2>
                        <div class="input-group">
                            <label for="json-file-input">א. העלאת קובץ JSON</label>
                            <label for="json-file-input" class="file-input-wrapper" id="json-drop-zone"><span class="material-symbols-outlined">upload_file</span><p>לחץ לבחירת קובץ או גרור לכאן</p><div id="json-file-name" class="file-name"></div></label>
                            <input type="file" id="json-file-input" accept=".json,application/json">
                        </div>
                        <div class="input-group">
                             <label for="json-text-input">ב. או הדבקת טקסט JSON</label>
                            <textarea id="json-text-input" placeholder='[{"id":1,"start_time":"00:00:01.234","end_time":"00:00:05.678","text":"..."}]'></textarea>
                        </div>
                    </div>
                    <div class="card">
                        <h2>שלב 2: הוספת מדיה</h2>
                        <div class="input-group" style="flex-grow: 1; display: flex; flex-direction: column;">
                            <label for="media-file-input">העלאת קובץ MP3 או MP4</label>
                            <label for="media-file-input" class="file-input-wrapper" id="media-drop-zone"><span class="material-symbols-outlined">movie</span><p>לחץ לבחירת קובץ או גרור לכאן</p><div id="media-file-name" class="file-name"></div></label>
                            <input type="file" id="media-file-input" accept="audio/mp3,video/mp4">
                        </div>
                         <div style="text-align: center; margin-top: 2rem;">
                            <button id="process-button" class="btn btn-primary" style="padding: 16px 32px; font-size: 1.2rem;" disabled><span class="material-symbols-outlined">edit_note</span> צור וערוך כתוביות</button>
                        </div>
                    </div>
                </div>
            </section>
            <section id="editor-section">
                 <div class="editor-controls">
                     <button id="back-to-input-btn" class="btn btn-secondary"><span class="material-symbols-outlined">arrow_back</span> חזרה</button>
                     <button id="download-srt-button" class="btn btn-primary"><span class="material-symbols-outlined">download</span> הורד קובץ SRT</button>
                     <h2 style="margin: 0; border: none; padding: 0;">עריכת כתוביות</h2>
                 </div>
                <div id="editor-grid">
                    <div id="media-player-container">
                        <div id="media-player-wrapper">
                            <video id="media-player"></video>
                            <div id="audio-poster"></div>
                        </div>
                        <div class="custom-controls">
                            <div class="progress-container">
                                <span class="time-display" id="current-time">00:00</span>
                                <input type="range" id="progress-bar" class="progress-bar" value="0" min="0" max="100" step="0.1">
                                <span class="time-display" id="duration">00:00</span>
                            </div>
                            <div class="bottom-controls">
                                <button class="control-btn" id="play-pause-btn"><span class="material-symbols-outlined">play_arrow</span></button>
                                <div class="volume-container">
                                    <button class="control-btn" id="volume-btn"><span class="material-symbols-outlined">volume_up</span></button>
                                    <input type="range" id="volume-bar" min="0" max="1" step="0.01" value="1">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="subtitle-list-container">
                        <h3>רשימת כתוביות</h3>
                        <div id="subtitle-list"></div>
                    </div>
                </div>
            </section>
        </main>
        <div id="notification"></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const jsonFileInput = document.getElementById('json-file-input'),
            jsonDropZone = document.getElementById('json-drop-zone'),
            jsonTextInput = document.getElementById('json-text-input'),
            mediaFileInput = document.getElementById('media-file-input'),
            mediaDropZone = document.getElementById('media-drop-zone'),
            jsonFileName = document.getElementById('json-file-name'),
            mediaFileName = document.getElementById('media-file-name'),
            processButton = document.getElementById('process-button'),
            backToInputBtn = document.getElementById('back-to-input-btn'),
            downloadSrtButton = document.getElementById('download-srt-button'),
            inputSection = document.getElementById('input-section'),
            editorSection = document.getElementById('editor-section'),
            notification = document.getElementById('notification'),
            mediaPlayer = document.getElementById('media-player'),
            audioPoster = document.getElementById('audio-poster'),
            playPauseBtn = document.getElementById('play-pause-btn'),
            playPauseIcon = playPauseBtn.querySelector('span'),
            progressBar = document.getElementById('progress-bar'),
            currentTimeEl = document.getElementById('current-time'),
            durationEl = document.getElementById('duration'),
            volumeBtn = document.getElementById('volume-btn'),
            volumeIcon = volumeBtn.querySelector('span'),
            volumeBar = document.getElementById('volume-bar'),
            subtitleList = document.getElementById('subtitle-list');

        let state = { subtitles: [], mediaURL: null, jsonContent: null, mediaFile: null, activeSubtitleId: null };
        
        const showNotification = (message, type = 'info', duration = 3000) => {
            notification.textContent = message;
            notification.className = 'show';
            if (type === 'error') notification.classList.add('error');
            setTimeout(() => { notification.className = ''; }, duration);
        };

        const checkInputs = () => { processButton.disabled = !(state.jsonContent && state.mediaURL); };
        
        const timeStringToSeconds = (timeStr) => {
            if (!timeStr || typeof timeStr !== 'string') return 0;
            const parts = timeStr.replace(',', '.').split(':');
            let seconds = 0;
            if (parts.length === 3) {
                const lastPart = parts[2];
                if (lastPart.includes('.')) {
                    seconds = parseFloat(parts[0]) * 3600 + parseFloat(parts[1]) * 60 + parseFloat(lastPart);
                } else {
                    seconds = parseFloat(parts[0]) * 60 + parseFloat(parts[1]) + parseFloat(lastPart) / 1000;
                }
            } else if (parts.length === 2) {
                seconds = parseFloat(parts[0]) * 60 + parseFloat(parts[1]);
            }
            return isNaN(seconds) ? 0 : seconds;
        };

        const secondsToTimeString = (seconds, useComma = false) => {
            if (isNaN(seconds) || seconds < 0) seconds = 0;
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0'),
                m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0'),
                s = Math.floor(seconds % 60).toString().padStart(2, '0'),
                ms = Math.round((seconds - Math.floor(seconds)) * 1000).toString().padStart(3, '0');
            return `${h}:${m}:${s}${useComma ? ',' : '.'}${ms}`;
        };

        const formatTimeForDisplay = (time) => {
            if (isNaN(time)) return "00:00";
            const m = Math.floor(time / 60).toString().padStart(2, '0'),
                s = Math.floor(time % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        };

        const handleJsonFile = (file) => {
            if (file && (file.type === "application/json" || file.name.endsWith('.json'))) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    state.jsonContent = e.target.result;
                    jsonFileName.textContent = `קובץ: ${file.name}`;
                    jsonTextInput.value = '';
                    checkInputs();
                };
                reader.onerror = () => showNotification('שגיאה בקריאת ה-JSON.', 'error');
                reader.readAsText(file);
            } else { showNotification('יש לבחור קובץ JSON.', 'error'); }
        };
        
        const handleMediaFile = (file) => {
             if (file && (file.type.startsWith('audio/') || file.type.startsWith('video/'))) {
                if (state.mediaURL) URL.revokeObjectURL(state.mediaURL);
                state.mediaFile = file; // Store the file object
                state.mediaURL = URL.createObjectURL(file);
                mediaFileName.textContent = `קובץ: ${file.name}`;
                checkInputs();
            } else { showNotification('יש לבחור קובץ MP3 או MP4.', 'error'); }
        };

        jsonFileInput.addEventListener('change', (e) => handleJsonFile(e.target.files[0]));
        mediaFileInput.addEventListener('change', (e) => handleMediaFile(e.target.files[0]));
        jsonTextInput.addEventListener('input', () => {
            state.jsonContent = jsonTextInput.value.trim().length > 0 ? jsonTextInput.value : null;
            if(state.jsonContent) { jsonFileInput.value = ''; jsonFileName.textContent = ''; }
            checkInputs();
        });
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => { document.body.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }); });
        [jsonDropZone, mediaDropZone].forEach(zone => {
            zone.addEventListener('dragover', () => zone.classList.add('drag-over'), false);
            zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'), false);
        });
        jsonDropZone.addEventListener('drop', e => { jsonDropZone.classList.remove('drag-over'); handleJsonFile(e.dataTransfer.files[0]); });
        mediaDropZone.addEventListener('drop', e => { mediaDropZone.classList.remove('drag-over'); handleMediaFile(e.dataTransfer.files[0]); });

        processButton.addEventListener('click', () => {
            try {
                const parsedJson = JSON.parse(state.jsonContent);
                if (!Array.isArray(parsedJson)) throw new Error("ה-JSON אינו מערך.");
                state.subtitles = parsedJson.map((item, index) => ({ ...item, id: item.id || Date.now() + index }));
                renderEditor();
            } catch (error) { showNotification(`שגיאה ב-JSON: ${error.message}`, 'error'); }
        });
        
        backToInputBtn.addEventListener('click', () => {
            editorSection.style.display = 'none';
            inputSection.style.display = 'block';
            mediaPlayer.pause();
        });
        
        const renderEditor = () => {
            inputSection.style.display = 'none';
            editorSection.style.display = 'block';
            mediaPlayer.src = state.mediaURL;
            if (state.mediaFile.type.startsWith('audio/')) {
                audioPoster.textContent = state.mediaFile.name;
                audioPoster.classList.add('visible');
            } else {
                audioPoster.classList.remove('visible');
            }
            subtitleList.innerHTML = '';
            state.subtitles.sort((a,b) => timeStringToSeconds(a.start_time) - timeStringToSeconds(b.start_time));
            state.subtitles.forEach(sub => {
                const itemEl = document.createElement('div');
                itemEl.className = 'subtitle-item';
                itemEl.dataset.id = sub.id;
                const displayStartTime = secondsToTimeString(timeStringToSeconds(sub.start_time)),
                      displayEndTime = secondsToTimeString(timeStringToSeconds(sub.end_time));
                itemEl.innerHTML = `<div class="time-inputs"><input type="text" class="time-input start-time" value="${displayStartTime}"><span>&rarr;</span><input type="text" class="time-input end-time" value="${displayEndTime}"></div><textarea class="text-input">${sub.text}</textarea>`;
                itemEl.addEventListener('click', e => { if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') { mediaPlayer.currentTime = timeStringToSeconds(sub.start_time); mediaPlayer.play(); } });
                const updateSub = (field, value) => state.subtitles.find(s => s.id == sub.id)[field] = value;
                itemEl.querySelector('.start-time').addEventListener('change', e => updateSub('start_time', e.target.value));
                itemEl.querySelector('.end-time').addEventListener('change', e => updateSub('end_time', e.target.value));
                itemEl.querySelector('.text-input').addEventListener('input', e => updateSub('text', e.target.value));
                subtitleList.appendChild(itemEl);
            });
        };
        
        const togglePlay = () => mediaPlayer.paused ? mediaPlayer.play() : mediaPlayer.pause();
        playPauseBtn.addEventListener('click', togglePlay);
        mediaPlayer.addEventListener('click', togglePlay);
        audioPoster.addEventListener('click', togglePlay);
        mediaPlayer.addEventListener('play', () => playPauseIcon.textContent = 'pause');
        mediaPlayer.addEventListener('pause', () => playPauseIcon.textContent = 'play_arrow');
        mediaPlayer.addEventListener('loadedmetadata', () => durationEl.textContent = formatTimeForDisplay(mediaPlayer.duration));
        mediaPlayer.addEventListener('timeupdate', () => {
            progressBar.value = (mediaPlayer.currentTime / mediaPlayer.duration) * 100;
            currentTimeEl.textContent = formatTimeForDisplay(mediaPlayer.currentTime);
            const currentSub = state.subtitles.find(s => mediaPlayer.currentTime >= timeStringToSeconds(s.start_time) && mediaPlayer.currentTime < timeStringToSeconds(s.end_time));
            if (currentSub && state.activeSubtitleId !== currentSub.id) {
                subtitleList.querySelector(`[data-id="${state.activeSubtitleId}"]`)?.classList.remove('active');
                const newActiveEl = subtitleList.querySelector(`[data-id="${currentSub.id}"]`);
                if(newActiveEl) { newActiveEl.classList.add('active'); newActiveEl.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                state.activeSubtitleId = currentSub.id;
            } else if (!currentSub && state.activeSubtitleId) {
                subtitleList.querySelector(`[data-id="${state.activeSubtitleId}"]`)?.classList.remove('active');
                state.activeSubtitleId = null;
            }
        });
        progressBar.addEventListener('input', () => mediaPlayer.currentTime = (progressBar.value / 100) * mediaPlayer.duration);
        volumeBar.addEventListener('input', (e) => { mediaPlayer.volume = e.target.value; mediaPlayer.muted = e.target.value == 0; });
        mediaPlayer.addEventListener('volumechange', () => {
            volumeBar.value = mediaPlayer.muted ? 0 : mediaPlayer.volume;
            if (mediaPlayer.muted || mediaPlayer.volume === 0) volumeIcon.textContent = 'volume_off';
            else if (mediaPlayer.volume < 0.5) volumeIcon.textContent = 'volume_down';
            else volumeIcon.textContent = 'volume_up';
        });
        volumeBtn.addEventListener('click', () => mediaPlayer.muted = !mediaPlayer.muted);
        
        const generateSrtContent = () => {
            const sortedSubs = [...state.subtitles].sort((a,b) => timeStringToSeconds(a.start_time) - timeStringToSeconds(b.start_time));
            return sortedSubs.map((sub, index) => `${index + 1}\n${secondsToTimeString(timeStringToSeconds(sub.start_time), true)} --> ${secondsToTimeString(timeStringToSeconds(sub.end_time), true)}\n${sub.text.trim()}\n`).join('\n');
        };
        
        downloadSrtButton.addEventListener('click', () => {
            const srtContent = generateSrtContent();
            if (!srtContent) return showNotification('אין כתוביות להורדה.', 'error');
            const blob = new Blob([srtContent], { type: 'text/plain;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${(state.mediaFile.name || 'subtitles').replace(/\.[^/.]+$/, "")}.srt`;
            a.click();
            URL.revokeObjectURL(a.href);
            showNotification('קובץ SRT נוצר והורד בהצלחה!');
        });
    });
    </script>
</body>
</html>